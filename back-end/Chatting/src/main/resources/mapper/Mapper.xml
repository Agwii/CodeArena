<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssafy.codearena.Chatting.mapper.GameMapper">
    <resultMap id="gameInfo" type="GameInfoDto">
        <result column="game_id" property="gameId"/>
        <result column="game_title" property="title"/>
        <result column="player1" property="userRed"/>
        <result column="player2" property="userBlue"/>
        <result column="problem_id" property="problemId"/>
        <result column="game_mode" property="gameMode"/>
        <result column="start_time" property="startTime"/>
        <result column="game_language" property="language"/>
    </resultMap>
    <!-- 검색조건 동적쿼리 -->
    <sql id="search">
        <if test='word != null and word != ""'>
            <if test="key == 'problem_id'">
                AND ${key} = #{word}
            </if>
            <if test="key == 'userId'">
                AND player1 = #{word} OR player2 = #{word}
            </if>
        </if>
    </sql>
    <!-- 게임모드 동적쿼리 -->
    <sql id="mode">
        <if test='gameMode != null and gameMode != ""'>
            AND game_mode = #{gameMode}
        </if>
        <if test='gameMode == null and gameMode == ""'>
            AND game_mode = 1;
        </if>
    </sql>
    <!-- 정렬조건 동적쿼리 -->
    <sql id="sort">
        <if test='sortType == null and sortType == ""'>
            ORDER BY start_time DESC
        </if>
        <if test="sortType == 'old'">
            ORDER BY start_time ASC
        </if>
    </sql>

    <!-- 승자 판단 동적쿼리-->
    <sql id="winner">
        <if test='winner != null and winner != ""'>
            SET winner = #{winner}
        </if>
    </sql>

    <!-- 랜덤 문제번호 조회 -->
    <select id="findProblemById" resultType="int">
        SELECT problem_id
        FROM code_arena.ps_list
        ORDER BY RAND() LIMIT 1;
    </select>
    <!-- 특정 게임방 조회 -->
    <select id="findRoomById" parameterType="string" resultMap="gameInfo">
        SELECT game_id, game_title, player1, player2, problem_id, start_time, game_mode, game_language
        FROM competitive_game_list
        WHERE game_id = #{gameId};
    </select>
    <!-- 게임방 생성 -->
    <insert id="createPrivateRoom" parameterType="gameCreateDto">
        INSERT INTO competitive_game_list(game_id, game_title, player1, player2, problem_id, start_time, game_mode, game_language)
        VALUES(#{gameId}, #{title}, #{userRed}, #{userBlue}, #{problemId}, now(), #{gameMode}, #{language});
    </insert>
    <!-- 게임방 목록 조회 -->
    <select id="findAllRoom" parameterType="map" resultMap="gameInfo">
        SELECT game_id, game_title, player1, player2, problem_id, start_time, game_mode, game_language
        FROM competitive_game_list
        WHERE end_time IS NULL
        <where>
            <include refid="mode"/>
            <include refid="search"/>
        </where>
        <include refid="sort"/>
        LIMIT ${start}, ${listSize};
    </select>
    <!-- 페이지 개수 조회 -->
    <select id="getTotalGameCount" parameterType="map" resultType="int">
        select count(game_id)
        from competitive_game_list
        <where>
            <include refid="search"></include>
        </where>
    </select>

    <update id="terminateGame" parameterType="string">
        UPDATE competitive_game_list
        SET end_time = now()
        <set>
            <include refid="winner"></include>
        </set>
        WHERE game_id = #{gameId};
    </update>
</mapper>